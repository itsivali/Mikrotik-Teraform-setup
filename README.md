# Mikrotik Azure S2S VPN Terraform Setup

## Overview

This project provides a modular, scalable Terraform configuration to deploy an Azure Site-to-Site (S2S) VPN infrastructure for connecting a Mikrotik router to Azure. The setup uses best practices for modularity, maintainability, and reusability, making it easy to extend or adapt for other hybrid network scenarios.

## Architecture

The solution provisions the following Azure resources:

- **Resource Group**: Logical container for all resources.
- **Virtual Network (VNet)**: Main network for Azure resources.
- **Gateway Subnet**: Dedicated subnet for the VPN gateway.
- **Public IP**: For the VPN gateway.
- **Virtual Network Gateway**: Azure VPN gateway for S2S connection.
- **Local Network Gateway**: Represents the Mikrotik router/public IP and on-premises address space.
- **VPN Connection**: IPsec/IKEv2 S2S connection between Azure and Mikrotik.

All resources are defined as reusable modules:

- `modules/resource_group`
- `modules/network`
- `modules/vpn_gateway`
- `modules/local_network_gateway`
- `modules/vpn_connection`

## Directory Structure

```
.
├── main.tf
├── README.md
└── modules
    ├── resource_group
    ├── network
    ├── vpn_gateway
    ├── local_network_gateway
    └── vpn_connection
```

## Prerequisites

- [Terraform](https://www.terraform.io/downloads.html) >= 1.0
- Azure subscription with sufficient permissions
- Mikrotik router with a public IP and IPsec/IKEv2 support
- [Azure CLI](https://docs.microsoft.com/en-us/cli/azure/install-azure-cli) (optional, for authentication)

## Usage

1. **Clone the repository**
   ```powershell
   git clone <repo-url>
   cd Mikrotik-Teraaform setup
   ```

2. **Authenticate with Azure**
   ```powershell
   az login
   ```

3. **Initialize Terraform**
   ```powershell
   terraform init
   ```

4. **Review and customize variables**
   - Edit `main.tf` or module variables as needed (e.g., address spaces, shared key, Mikrotik public IP).

5. **Plan the deployment**
   ```powershell
   terraform plan
   ```

6. **Apply the deployment**
   ```powershell
   terraform apply
   ```

7. **Configure Mikrotik Router**
   - Use the output values and your shared key to configure the Mikrotik side of the VPN.
   - Ensure matching IPsec/IKEv2 settings.

## Module Details

### resource_group
- Creates the Azure resource group.
  - Inputs: `name`, `location`
  - Outputs: `name`, `location`, `id`

### network
- Provisions the VNet and GatewaySubnet.
  - Inputs: `name`, `address_space`, `location`, `resource_group_name`, `gateway_subnet_prefixes`
  - Outputs: `vnet_id`, `gateway_subnet_id`

### vpn_gateway
- Deploys the public IP and VPN gateway.
  - Inputs: `public_ip_name`, `location`, `resource_group_name`, `allocation_method`, `sku`, `gateway_name`, `gateway_type`, `vpn_type`, `gateway_sku`, `ip_config_name`, `gateway_subnet_id`, `private_ip_allocation`, `active_active`, `enable_bgp`
  - Outputs: `gateway_id`, `public_ip_id`

### local_network_gateway
- Represents the Mikrotik router and on-premises network.
  - Inputs: `name`, `location`, `resource_group_name`, `gateway_address`, `address_space`
  - Outputs: `id`

### vpn_connection
- Creates the S2S VPN connection.
  - Inputs: `name`, `location`, `resource_group_name`, `virtual_network_gateway_id`, `local_network_gateway_id`, `type`, `connection_protocol`, `shared_key`, `enable_bgp`, `use_policy_based_traffic_selectors`
  - Outputs: `id`

## Customization

- **Address Spaces**: Change VNet and on-premises address spaces in `main.tf` or module variables.
- **Shared Key**: Update the `shared_key` variable for your VPN connection.
- **Mikrotik IP**: Set your Mikrotik public IP in the `local_network_gateway` module block.
- **Additional Subnets/Resources**: Add more modules or extend existing ones as needed.

## Troubleshooting

- Ensure all variables are set correctly and match on both Azure and Mikrotik sides.
- Use `terraform output` to get resource IDs and connection info.
- Check Azure Portal for resource status and logs.
- For VPN issues, verify IPsec/IKEv2 settings and shared key on both ends.

## Clean Up

To destroy all resources:

```powershell
terraform destroy
```

## References

- [Azure S2S VPN Documentation](https://docs.microsoft.com/en-us/azure/vpn-gateway/vpn-gateway-howto-site-to-site-resource-manager-portal)
- [Terraform AzureRM Provider](https://registry.terraform.io/providers/hashicorp/azurerm/latest/docs)
- [Mikrotik IPsec Setup](https://wiki.mikrotik.com/wiki/Manual:IP/IPsec)

---
*Generated by GitHub Copilot — July 2025*
